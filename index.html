<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>DailyDoseofBCA</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --bg-base: #000000;
            --accent-blue: #0a84ff;
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            background-color: var(--bg-base);
            color: #ffffff;
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", system-ui;
        }

        .view { position: fixed; inset: 0; display: none; flex-direction: column; z-index: 10; background: black; }
        .view.active { display: flex; }

        .ios-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 16px;
            color: white;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }
        .ios-input:focus { border-color: var(--accent-blue); }

        .ios-btn {
            width: 100%;
            background: var(--accent-blue);
            color: white;
            border-radius: 16px;
            padding: 18px;
            font-weight: 700;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .ios-btn:active:not(:disabled) { transform: scale(0.96); opacity: 0.8; }
        .ios-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .slider-track { display: flex; height: 100%; transition: transform 0.5s cubic-bezier(0.2, 1, 0.3, 1); }
        .slide { min-width: 100%; height: 100%; overflow-y: auto; padding: 0 24px 140px; }

        #profile-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(25px);
            display: none;
            justify-content: center;
            align-items: flex-end;
            z-index: 3000;
        }

        .modal-content {
            width: 100%;
            background: #1c1c1e;
            border-radius: 32px 32px 0 0;
            padding: 30px 24px env(safe-area-inset-bottom);
        }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
            display: none;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading .spinner { display: block; }
        .loading .btn-text { display: none; }
    </style>
</head>
<body>

    <!-- AUTHENTICATION VIEW (Login/Signup) -->
    <div id="view-auth" class="view active items-center justify-center p-6">
        <div class="w-full max-w-[400px] text-center">
            <h1 id="auth-title" class="text-4xl font-black mb-2 tracking-tight">DailyDose</h1>
            <p id="auth-subtitle" class="text-zinc-500 mb-10 text-sm">Access notes, assignments & labs.</p>
            
            <div class="space-y-3 text-left">
                <input type="text" id="reg-name" class="ios-input hidden" placeholder="Full Name">
                <input type="email" id="reg-email" class="ios-input" placeholder="Email Address">
                <input type="password" id="reg-pass" class="ios-input" placeholder="Password">
            </div>

            <button id="btn-auth-submit" class="ios-btn mt-8">
                <span class="btn-text">Continue</span>
                <div class="spinner"></div>
            </button>
            
            <p id="auth-toggle" class="mt-8 text-sm text-blue-500 font-bold cursor-pointer">Don't have an account? Sign Up</p>
            <p id="auth-msg" class="mt-4 text-xs font-medium min-h-[1.2rem]"></p>
        </div>
    </div>

    <!-- PROFILE PICTURE SETUP VIEW (Asked after signup) -->
    <div id="view-setup-pfp" class="view items-center justify-center p-6">
        <div class="w-full max-w-[400px] text-center">
            <div class="mb-10 flex flex-col items-center">
                <h1 class="text-3xl font-black mb-2">Welcome, <span id="setup-user-name" class="text-blue-500">Student</span>!</h1>
                <p class="text-zinc-500 text-sm">Let's set a profile picture for your workspace.</p>
            </div>

            <div class="relative inline-block mb-10">
                <img id="setup-pfp-preview" src="https://ui-avatars.com/api/?name=User&background=0a84ff&color=fff" class="w-32 h-32 rounded-full object-cover border-4 border-white/10 bg-zinc-800 shadow-2xl">
                <input type="file" id="setup-pfp-input" class="hidden" accept="image/*">
                <button onclick="document.getElementById('setup-pfp-input').click()" class="absolute -bottom-1 -right-1 bg-blue-600 p-3 rounded-full border-4 border-black active:scale-90 transition-transform">
                    <i data-lucide="camera" size="20"></i>
                </button>
            </div>

            <div class="space-y-3">
                <button id="btn-setup-finish" class="ios-btn">
                    <span class="btn-text">Finish Setup</span>
                    <div class="spinner"></div>
                </button>
                <button id="btn-setup-skip" class="w-full py-4 text-zinc-500 font-bold text-sm">Skip for now</button>
            </div>
            
            <p id="setup-msg" class="mt-6 text-xs font-medium text-zinc-500"></p>
        </div>
    </div>

    <!-- HOME VIEW -->
    <div id="view-home" class="view">
        <header class="pt-16 px-6 pb-4 flex justify-between items-center">
            <div>
                <h2 class="text-[10px] font-black text-blue-500 uppercase tracking-widest">DailyDose Workspace</h2>
                <h1 id="user-display-name" class="text-3xl font-bold tracking-tight">Student</h1>
            </div>
            <button onclick="toggleProfile()" class="active:scale-90 transition-transform">
                <img id="header-avatar" src="" class="w-12 h-12 rounded-full border-2 border-white/10 object-cover bg-zinc-800">
            </button>
        </header>

        <div class="slider-viewport flex-1 overflow-hidden relative" id="viewport">
            <div class="slider-track" id="track">
                <div class="slide">
                    <h2 class="text-xl font-bold mb-6 text-zinc-400">Notes</h2>
                    <div class="bg-zinc-900/50 p-6 rounded-[28px] border border-white/5 mb-4">
                        <h3 class="text-lg font-bold mb-1">Android Development</h3>
                        <p class="text-sm text-zinc-500 mb-6">Complete guide to Fragments & Lifecycle.</p>
                        <button onclick="window.open('https://drive.google.com')" class="w-full py-4 bg-zinc-100 text-black rounded-2xl font-bold text-sm">Open Drive PDF</button>
                    </div>
                </div>
                <div class="slide"><h2 class="text-xl font-bold mb-6 text-zinc-400">Assignments</h2></div>
                <div class="slide"><h2 class="text-xl font-bold mb-6 text-zinc-400">Lab Manuals</h2></div>
            </div>
        </div>

        <div class="fixed bottom-10 left-0 w-full flex justify-center px-6 pointer-events-none">
            <nav class="w-full max-w-[400px] h-20 bg-zinc-900/80 backdrop-blur-2xl border border-white/10 rounded-[40px] flex items-center p-2 pointer-events-auto">
                <div id="nav-indicator" class="absolute h-16 w-[calc((100%-16px)/3)] bg-white/5 border border-white/10 rounded-[32px] transition-transform duration-500 cubic-bezier(0.2, 1, 0.3, 1)"></div>
                <div class="flex-1 flex flex-col items-center justify-center z-10 text-white" onclick="snap(0)">
                    <i data-lucide="book-open"></i>
                </div>
                <div class="flex-1 flex flex-col items-center justify-center z-10 text-zinc-500" onclick="snap(1)">
                    <i data-lucide="edit-3"></i>
                </div>
                <div class="flex-1 flex flex-col items-center justify-center z-10 text-zinc-500" onclick="snap(2)">
                    <i data-lucide="flask-conical"></i>
                </div>
            </nav>
        </div>
    </div>

    <!-- PROFILE MODAL -->
    <div id="profile-modal" onclick="toggleProfile()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex flex-col items-center mb-10">
                <div class="relative">
                    <img id="modal-avatar" src="" class="w-24 h-24 rounded-full object-cover border-4 border-blue-500 bg-zinc-800">
                    <input type="file" id="pfp-upload" class="hidden" accept="image/*">
                    <button id="pfp-trigger" class="absolute -bottom-2 -right-2 bg-blue-600 p-3 rounded-full border-4 border-[#1c1c1e]">
                        <i data-lucide="camera" size="18"></i>
                    </button>
                </div>
                <h3 id="profile-name-label" class="text-2xl font-bold mt-4">Name</h3>
                <p id="profile-email-label" class="text-zinc-500 text-sm">email@student.com</p>
            </div>
            <div class="space-y-8">
                <div>
                    <label class="text-[10px] font-black uppercase text-zinc-500 tracking-widest mb-3 block">Display Identity</label>
                    <div class="flex gap-3">
                        <input type="text" id="new-name" class="ios-input flex-1" placeholder="New name">
                        <button id="btn-update-name" class="bg-white text-black px-6 rounded-2xl font-bold text-sm disabled:opacity-30">Update</button>
                    </div>
                    <p id="name-count-status" class="text-[11px] mt-3 text-zinc-500 font-medium">5 changes remaining</p>
                </div>
                <div class="pt-6 border-t border-white/5">
                    <button onclick="handleSignOut()" class="w-full py-5 bg-red-500/10 text-red-500 rounded-3xl font-bold text-sm">Sign Out</button>
                    <button onclick="toggleProfile()" class="w-full py-4 text-zinc-600 font-bold text-sm mt-2">Dismiss</button>
                </div>
            </div>
        </div>
    </div>

<script>
    lucide.createIcons();

    // Supabase Initialization
    const SB_URL = 'https://nsvkbxssnjjwhsrsxirs.supabase.co'; 
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zdmtieHNzbmpqd2hzcnN4aXJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0MDA4NzksImV4cCI6MjA4MTk3Njg3OX0.S5GgEm49x6nJFmnOSsFI3Nte-mwNmVUbwTkxqa8h3yE';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    const views = {
        auth: document.getElementById('view-auth'),
        setup: document.getElementById('view-setup-pfp'),
        home: document.getElementById('view-home')
    };

    let isLoginMode = true;
    let selectedSetupFile = null;

    function setView(target) {
        Object.values(views).forEach(v => v.classList.remove('active'));
        views[target].classList.add('active');
    }

    // AUTH SWITCH
    document.getElementById('auth-toggle').onclick = () => {
        isLoginMode = !isLoginMode;
        document.getElementById('auth-title').innerText = isLoginMode ? "Welcome Back" : "Create Account";
        document.getElementById('auth-subtitle').innerText = isLoginMode ? "Access notes, assignments & labs." : "Join the DailyDose student community.";
        document.getElementById('auth-toggle').innerText = isLoginMode ? "Don't have an account? Sign Up" : "Already have an account? Log In";
        document.getElementById('reg-name').classList.toggle('hidden', isLoginMode);
    };

    // SUBMIT AUTH
    document.getElementById('btn-auth-submit').onclick = async () => {
        const btn = document.getElementById('btn-auth-submit');
        const email = document.getElementById('reg-email').value.trim();
        const password = document.getElementById('reg-pass').value;
        const name = document.getElementById('reg-name').value.trim();
        const msg = document.getElementById('auth-msg');

        if(!email || !password || (!isLoginMode && !name)) {
            msg.innerText = "Please fill all fields.";
            msg.style.color = "#ff453a";
            return;
        }

        btn.classList.add('loading');
        btn.disabled = true;
        msg.innerText = "";

        if (isLoginMode) {
            const { error } = await _supabase.auth.signInWithPassword({ email, password });
            if (error) {
                msg.innerText = error.message;
                msg.style.color = "#ff453a";
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        } else {
            const { data, error } = await _supabase.auth.signUp({
                email, password,
                options: { 
                    data: { 
                        full_name: name, 
                        profile_changes_left: 5,
                        avatar_url: null 
                    } 
                }
            });
            
            if (error) {
                msg.innerText = error.message;
                msg.style.color = "#ff453a";
                btn.classList.remove('loading');
                btn.disabled = false;
            } else {
                if (!data.session) {
                    msg.innerText = "Check your email to verify your account!";
                    msg.style.color = "#34c759";
                    btn.classList.remove('loading');
                    btn.disabled = false;
                }
            }
        }
    };

    // SETUP PFP LOGIC
    document.getElementById('setup-pfp-input').onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            selectedSetupFile = file;
            const reader = new FileReader();
            reader.onload = (ev) => document.getElementById('setup-pfp-preview').src = ev.target.result;
            reader.readAsDataURL(file);
        }
    };

    document.getElementById('btn-setup-finish').onclick = async () => {
        if (!selectedSetupFile) return alert("Please select a photo or skip.");
        
        const btn = document.getElementById('btn-setup-finish');
        btn.classList.add('loading');
        btn.disabled = true;

        const { data: { user } } = await _supabase.auth.getUser();
        const filePath = `avatars/${user.id}-${Date.now()}`;
        
        const { error: upErr } = await _supabase.storage.from('avatars').upload(filePath, selectedSetupFile);
        if (upErr) {
            alert(upErr.message);
            btn.classList.remove('loading');
            btn.disabled = false;
            return;
        }

        const { data: { publicUrl } } = _supabase.storage.from('avatars').getPublicUrl(filePath);
        await _supabase.auth.updateUser({ data: { avatar_url: publicUrl } });
        
        setView('home');
        location.reload();
    };

    document.getElementById('btn-setup-skip').onclick = () => {
        setView('home');
    };

    // SESSION OBSERVER
    _supabase.auth.onAuthStateChange(async (event, session) => {
        if (session) {
            const user = session.user;
            const meta = user.user_metadata || {};
            // Priority: Metadata full_name > user's display name > default "Student"
            const displayName = meta.full_name || user.user_metadata?.full_name || "Student";
            
            // Welcome screen name update
            const setupNameLabel = document.getElementById('setup-user-name');
            if (setupNameLabel) setupNameLabel.innerText = displayName;

            // Redirect logic: If no PFP and not already on Home or Setup
            if (!meta.avatar_url && !views.home.classList.contains('active') && !views.setup.classList.contains('active')) {
                document.getElementById('setup-pfp-preview').src = `https://ui-avatars.com/api/?name=${displayName}&background=0a84ff&color=fff`;
                setView('setup');
                return;
            }

            setView('home');
            const pfp = meta.avatar_url || `https://ui-avatars.com/api/?name=${displayName}&background=0a84ff&color=fff`;
            const changesLeft = meta.profile_changes_left ?? 5;

            // Update Homepage Header with the actual user name
            document.getElementById('user-display-name').innerText = displayName;
            
            // Update Profile Modal Labels
            document.getElementById('profile-name-label').innerText = displayName;
            document.getElementById('profile-email-label').innerText = user.email;
            
            document.getElementById('header-avatar').src = pfp;
            document.getElementById('modal-avatar').src = pfp;
            document.getElementById('name-count-status').innerText = `${changesLeft} changes remaining`;
            
            const updateBtn = document.getElementById('btn-update-name');
            const pfpBtn = document.getElementById('pfp-trigger');
            if (changesLeft <= 0) {
                updateBtn.disabled = true;
                pfpBtn.style.display = 'none';
                document.getElementById('new-name').disabled = true;
                document.getElementById('new-name').placeholder = "No changes left";
            }
            snap(0);
        } else {
            setView('auth');
        }
    });

    // UI HELPERS
    function snap(idx) {
        document.getElementById('track').style.transform = `translateX(-${idx * 100}%)`;
        document.getElementById('nav-indicator').style.transform = `translateX(${idx * 100}%)`;
        
        const icons = document.querySelectorAll('nav i');
        icons.forEach((icon, i) => {
            icon.closest('div').classList.toggle('text-white', i === idx);
            icon.closest('div').classList.toggle('text-zinc-500', i !== idx);
        });
    }

    function toggleProfile() {
        const m = document.getElementById('profile-modal');
        m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
    }

    async function handleSignOut() {
        await _supabase.auth.signOut();
        toggleProfile();
    }

    // PROFILE UPDATES
    document.getElementById('pfp-trigger').onclick = () => document.getElementById('pfp-upload').click();
    document.getElementById('pfp-upload').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const { data: { user } } = await _supabase.auth.getUser();
        let left = user.user_metadata.profile_changes_left ?? 5;
        if (left <= 0) return alert("No changes remaining");

        document.getElementById('name-count-status').innerText = "Updating...";
        
        const filePath = `avatars/${user.id}-${Date.now()}`;
        const { error: upErr } = await _supabase.storage.from('avatars').upload(filePath, file);
        if(upErr) return alert(upErr.message);

        const { data: { publicUrl } } = _supabase.storage.from('avatars').getPublicUrl(filePath);
        await _supabase.auth.updateUser({ 
            data: { 
                avatar_url: publicUrl, 
                profile_changes_left: left - 1 
            } 
        });
        location.reload();
    };

    document.getElementById('btn-update-name').onclick = async () => {
        const newName = document.getElementById('new-name').value.trim();
        const { data: { user } } = await _supabase.auth.getUser();
        let left = user.user_metadata.profile_changes_left ?? 5;
        
        if (left <= 0) return alert("No changes remaining");
        if (!newName) return alert("Enter a name");

        document.getElementById('btn-update-name').innerText = "...";
        await _supabase.auth.updateUser({ 
            data: { 
                full_name: newName, 
                profile_changes_left: left - 1 
            } 
        });
        location.reload();
    };
</script>
</body>
</html>
