<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>Chatter - Community Chat</title>
    <meta name="description" content="Real-time community chat for DailyDoseofBCA students">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí¨</text></svg>">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --bg-base: #000000;
            --accent-blue: #007aff;
            --accent-green: #30d158;
            --accent-purple: #bf5af2;
            --glass-bg: rgba(255, 255, 255, 0.04);
            --glass-border: rgba(255, 255, 255, 0.1);
            --liquid-blur: blur(40px);
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-base);
            color: #ffffff;
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", system-ui;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            z-index: 0;
            opacity: 0.15;
            pointer-events: none;
        }

        .liquid-glass {
            background: var(--glass-bg);
            backdrop-filter: var(--liquid-blur);
            -webkit-backdrop-filter: var(--liquid-blur);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 20px 0 rgba(0, 0, 0, 0.5);
        }

        .view {
            position: fixed;
            inset: 0;
            display: none;
            flex-direction: column;
            z-index: 10;
            background: black;
        }

        .view.active {
            display: flex;
        }

        /* Login Styles */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 24px;
            text-align: center;
        }

        .login-card {
            width: 100%;
            max-width: 380px;
            padding: 40px 32px;
            border-radius: 32px;
        }

        .logo-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 36px;
        }

        /* Chat Container */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
            z-index: 10;
        }

        /* Chat Header */
        .chat-header {
            padding: 48px 20px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--glass-border);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            position: relative;
            z-index: 20;
        }

        .user-avatar-btn {
            width: 40px;
            height: 40px;
            border-radius: 14px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-avatar-btn:active {
            transform: scale(0.92);
        }

        .user-avatar-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Messages Area */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            scroll-behavior: smooth;
        }

        .messages-area::-webkit-scrollbar {
            width: 4px;
        }

        .messages-area::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-area::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        /* Message Bubbles */
        .message-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 85%;
            animation: messageSlideIn 0.3s cubic-bezier(0.2, 1, 0.3, 1);
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message-wrapper.own {
            align-self: flex-end;
        }

        .message-wrapper.other {
            align-self: flex-start;
            flex-direction: row;
        }

        .message-row {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            background: #1a1a1a;
        }

        .message-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0;
        }

        .message-sender {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.6;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.4;
            font-size: 15px;
        }

        .message-wrapper.own .message-bubble {
            background: linear-gradient(135deg, var(--accent-blue), #0055cc);
            border-bottom-right-radius: 6px;
            color: white;
        }

        .message-wrapper.other .message-bubble {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--glass-border);
            border-bottom-left-radius: 6px;
        }

        .message-time {
            font-size: 10px;
            opacity: 0.5;
            margin-top: 4px;
            text-align: right;
        }

        .message-wrapper.other .message-time {
            text-align: left;
        }

        .message-wrapper.own .message-time {
            padding-right: 12px;
        }

        /* Reactions */
        .message-reactions {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            flex-wrap: wrap;
        }

        .message-wrapper.own .message-reactions {
            justify-content: flex-end;
            padding-right: 8px;
        }

        .message-wrapper.other .message-reactions {
            padding-left: 8px;
        }

        .reaction-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .reaction-badge:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .reaction-badge.active {
            background: rgba(0, 122, 255, 0.15);
            border-color: rgba(0, 122, 255, 0.3);
        }

        .reaction-count {
            font-size: 10px;
            opacity: 0.7;
        }

        /* Input Area */
        .input-area {
            padding: 12px 16px 32px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            border-top: 1px solid var(--glass-border);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .message-input-wrapper {
            flex: 1;
            display: flex;
            align-items: flex-end;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 4px;
            transition: all 0.3s ease;
        }

        .message-input-wrapper:focus-within {
            border-color: var(--accent-blue);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            padding: 10px 16px;
            font-size: 15px;
            outline: none;
            resize: none;
            min-height: 40px;
            max-height: 120px;
            line-height: 1.4;
        }

        .message-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .send-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--accent-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.2, 1, 0.3, 1);
            flex-shrink: 0;
            border: none;
            cursor: pointer;
            color: white;
        }

        .send-btn:active {
            transform: scale(0.9);
        }

        .send-btn:disabled {
            opacity: 0.4;
            transform: scale(0.95);
        }

        /* Online Users Badge */
        .online-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(48, 209, 88, 0.1);
            border: 1px solid rgba(48, 209, 88, 0.2);
            border-radius: 12px;
            font-size: 11px;
            color: var(--accent-green);
        }

        .online-dot {
            width: 6px;
            height: 6px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.6;
                transform: scale(1.2);
            }
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            text-align: center;
            padding: 40px;
            opacity: 0.6;
        }

        .empty-state i {
            margin-bottom: 16px;
            opacity: 0.4;
        }

        .empty-state h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 13px;
            opacity: 0.6;
        }

        /* Loading View */
        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: var(--accent-blue);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Date Divider */
        .date-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 16px 0;
        }

        .date-divider span {
            padding: 6px 14px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            opacity: 0.5;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 6px;
            z-index: 100;
            display: none;
            min-width: 140px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
        }

        .context-menu.show {
            display: block;
            animation: contextPop 0.2s cubic-bezier(0.2, 1, 0.3, 1);
        }

        @keyframes contextPop {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .context-menu button {
            width: 100%;
            padding: 10px 14px;
            text-align: left;
            font-size: 14px;
            border-radius: 8px;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
        }

        .context-menu button:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .reaction-emoji {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            background: transparent;
            border: none;
            cursor: pointer;
        }

        .reaction-emoji:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.15);
        }

        .reaction-emoji:active {
            transform: scale(0.95);
        }

        /* Profile menu styles */
        .profile-menu-item {
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            font-size: 14px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .profile-menu-item:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .profile-menu-item.danger {
            color: #ff453a;
        }
    </style>
</head>

<body>
    <!-- Background Orbs -->
    <div class="orb w-[250px] h-[250px] bg-blue-600 top-[-80px] right-[-50px]"></div>
    <div class="orb w-[200px] h-[200px] bg-purple-600 bottom-[20%] left-[-60px]"></div>
    <div class="orb w-[150px] h-[150px] bg-green-500 bottom-[-40px] right-[20%]"></div>

    <!-- LOADING VIEW -->
    <div id="view-loading" class="view active items-center justify-center p-6 bg-black z-50">
        <div class="flex flex-col items-center gap-4">
            <div class="spinner"></div>
            <p id="loading-status" class="text-sm text-zinc-500">Connecting...</p>
        </div>
    </div>

    <!-- NO ACCESS VIEW (for direct access without session) -->
    <div id="view-login" class="view">
        <div class="login-container">
            <div class="login-card liquid-glass">
                <div class="logo-icon">ÔøΩ</div>
                <h1 class="text-2xl font-bold mb-2">Access Denied</h1>
                <p class="text-zinc-400 text-sm mb-6">Please open the chat from the DailyDoseofBCA app to continue.</p>
                <p class="text-zinc-600 text-xs">You need to be logged in to the app first.</p>
            </div>
        </div>
    </div>

    <!-- CHAT VIEW -->
    <div id="view-chat" class="view">
        <div class="chat-container">
            <!-- Chat Header -->
            <div class="chat-header">
                <button class="user-avatar-btn liquid-glass" onclick="showProfileMenu()">
                    <img id="header-avatar" src="https://ui-avatars.com/api/?name=U&background=0a84ff&color=fff"
                        alt="Avatar" style="background: #1a1a1a;">
                </button>
                <div class="flex-1">
                    <h1 class="text-lg font-bold">Community Chat</h1>
                    <div class="online-badge mt-1">
                        <div class="online-dot"></div>
                        <span id="online-count">0 online</span>
                    </div>
                </div>
                <button class="liquid-glass w-10 h-10 rounded-xl flex items-center justify-center"
                    onclick="showOnlineUsers()">
                    <i data-lucide="users" size="18"></i>
                </button>
            </div>

            <!-- Messages Area -->
            <div class="messages-area" id="messages-area">
                <div class="empty-state" id="empty-state">
                    <i data-lucide="message-circle" size="48"></i>
                    <h3>Start the Conversation</h3>
                    <p>Be the first to send a message!</p>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <div class="message-input-wrapper">
                    <textarea class="message-input" id="message-input" placeholder="Message..." rows="1"
                        oninput="handleInput(this)" onkeydown="handleKeyDown(event)"></textarea>
                </div>
                <button class="send-btn" id="send-btn" onclick="sendMessage()" disabled>
                    <i data-lucide="send" size="18"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="context-menu">
        <button onclick="addReaction()">
            <i data-lucide="smile" size="16"></i>
            React
        </button>
        <button onclick="copyMessage()">
            <i data-lucide="copy" size="16"></i>
            Copy
        </button>
    </div>

    <!-- Profile Menu Modal -->
    <div id="profile-modal"
        class="hidden fixed inset-0 z-[100] bg-black/80 backdrop-blur-xl flex items-end justify-center"
        onclick="hideProfileMenu()">
        <div class="w-full max-w-md liquid-glass rounded-t-[32px] p-6" onclick="event.stopPropagation()"
            style="animation: slideUp 0.3s cubic-bezier(0.2, 1, 0.3, 1);">
            <div class="w-8 h-1 bg-white/10 rounded-full mx-auto mb-6"></div>

            <div class="flex items-center gap-4 mb-6 pb-6 border-b border-white/10">
                <img id="profile-avatar" src="" class="w-14 h-14 rounded-2xl object-cover bg-zinc-800">
                <div class="flex-1">
                    <h3 id="profile-name" class="font-bold"></h3>
                    <p id="profile-email" class="text-zinc-500 text-sm"></p>
                </div>
            </div>

            <div class="space-y-2">
                <button class="profile-menu-item" onclick="showOnlineUsers(); hideProfileMenu();">
                    <i data-lucide="users" size="18"></i>
                    View Online Users
                </button>
                <button class="profile-menu-item danger" onclick="handleSignOut()">
                    <i data-lucide="log-out" size="18"></i>
                    Sign Out
                </button>
            </div>
        </div>
    </div>

    <!-- Online Users Modal -->
    <div id="online-modal"
        class="hidden fixed inset-0 z-[100] bg-black/80 backdrop-blur-xl flex items-end justify-center"
        onclick="hideOnlineUsers()">
        <div class="w-full max-w-md liquid-glass rounded-t-[32px] p-6" onclick="event.stopPropagation()"
            style="animation: slideUp 0.3s cubic-bezier(0.2, 1, 0.3, 1);">
            <div class="w-8 h-1 bg-white/10 rounded-full mx-auto mb-6"></div>
            <h3 class="text-lg font-bold mb-4 text-center">Online Users</h3>
            <div id="online-users-list" class="space-y-2 max-h-[50vh] overflow-y-auto"></div>
        </div>
    </div>

    <!-- Reaction Picker Modal -->
    <div id="reaction-modal" class="hidden fixed inset-0 z-[90] bg-black/60 flex items-center justify-center"
        onclick="hideReactionPicker()">
        <div class="liquid-glass rounded-2xl p-3 flex gap-2" onclick="event.stopPropagation()">
            <button class="reaction-emoji" onclick="selectReaction('üëç')">üëç</button>
            <button class="reaction-emoji" onclick="selectReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
            <button class="reaction-emoji" onclick="selectReaction('üòÇ')">üòÇ</button>
            <button class="reaction-emoji" onclick="selectReaction('üòÆ')">üòÆ</button>
            <button class="reaction-emoji" onclick="selectReaction('üò¢')">üò¢</button>
            <button class="reaction-emoji" onclick="selectReaction('üî•')">üî•</button>
        </div>
    </div>

    <script>
        lucide.createIcons();

        const SB_URL = 'https://nsvkbxssnjjwhsrsxirs.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zdmtieHNzbmpqd2hzcnN4aXJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0MDA4NzksImV4cCI6MjA4MTk3Njg3OX0.S5GgEm49x6nJFmnOSsFI3Nte-mwNmVUbwTkxqa8h3yE';
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        let currentUser = null;
        let messages = [];
        let selectedMessageId = null;
        let onlineUsers = new Map();
        let presenceChannel = null;
        let messagesChannel = null;

        const views = {
            loading: document.getElementById('view-loading'),
            login: document.getElementById('view-login'),
            chat: document.getElementById('view-chat')
        };

        function updateLoadingStatus(message) {
            const statusEl = document.getElementById('loading-status');
            if (statusEl) statusEl.textContent = message;
            console.log('Status:', message);
        }

        function setView(target) {
            Object.values(views).forEach(v => v.classList.remove('active'));
            views[target].classList.add('active');
        }

        // Auth Functions        // No sign-in function - users must come from the app with session tokens
        async function handleSignOut() {
            hideProfileMenu();
            updateLoadingStatus('Signing out...');
            setView('loading');

            if (presenceChannel) {
                await presenceChannel.untrack();
                presenceChannel.unsubscribe();
            }
            if (messagesChannel) {
                messagesChannel.unsubscribe();
            }

            await _supabase.auth.signOut();
            setView('login');
        }

        // Initialize Auth - Check for session from URL hash or existing session
        const initialHash = window.location.hash;

        async function tryRecoverSessionFromHash() {
            // Check if we have session tokens in URL (from app navigation)
            if (initialHash && initialHash.includes('access_token')) {
                updateLoadingStatus('Restoring session...');
                const params = new URLSearchParams(initialHash.substring(1));
                const access_token = params.get('access_token');
                const refresh_token = params.get('refresh_token');

                if (access_token && refresh_token) {
                    try {
                        const { data, error } = await _supabase.auth.setSession({
                            access_token,
                            refresh_token
                        });

                        if (data.session) {
                            console.log('Session restored from URL hash');
                            // Clean the URL
                            window.history.replaceState(null, '', window.location.pathname);
                            return data.session;
                        }
                    } catch (e) {
                        console.error('Error setting session from hash:', e);
                    }
                }
            }
            return null;
        }

        async function checkExistingSession() {
            updateLoadingStatus('Checking session...');

            // First try to recover session from URL hash (from app)
            let session = await tryRecoverSessionFromHash();

            // If no session from hash, check for existing stored session
            if (!session) {
                const { data, error } = await _supabase.auth.getSession();
                session = data?.session;
            }

            if (session) {
                console.log('Session found, going to chat');
                currentUser = session.user;
                updateLoadingStatus('Loading chat...');
                await initializeChat();
                updateUserUI();
                setView('chat');
            } else {
                console.log('No session, showing login');
                setView('login');
            }
        }

        // Listen for auth changes (login, logout, token refresh)
        _supabase.auth.onAuthStateChange(async (event, session) => {
            console.log('Auth state changed:', event, session ? 'has session' : 'no session');

            if (event === 'SIGNED_IN' && session) {
                currentUser = session.user;
                updateLoadingStatus('Loading chat...');
                await initializeChat();
                updateUserUI();
                setView('chat');
            } else if (event === 'SIGNED_OUT') {
                setView('login');
            }
        });

        // Start the app
        checkExistingSession();

        function updateUserUI() {
            if (!currentUser) return;

            const userName = currentUser.user_metadata?.full_name || 'User';
            const userEmail = currentUser.email || '';
            const userAvatar = currentUser.user_metadata?.avatar_url ||
                `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=0a84ff&color=fff`;

            console.log('Updating UI - Avatar URL:', userAvatar);

            document.getElementById('header-avatar').src = userAvatar;
            document.getElementById('profile-avatar').src = userAvatar;
            document.getElementById('profile-name').textContent = userName;
            document.getElementById('profile-email').textContent = userEmail;
        }

        function showProfileMenu() {
            document.getElementById('profile-modal').classList.remove('hidden');
        }

        function hideProfileMenu() {
            document.getElementById('profile-modal').classList.add('hidden');
        }

        // Chat Functions
        async function initializeChat() {
            setView('chat');
            await loadMessages();

            // Setup realtime immediately (no delay)
            console.log('Initializing realtime features...');
            setupRealtimeSubscription();
            setupPresence();
        }

        async function loadMessages() {
            const emptyState = document.getElementById('empty-state');

            try {
                console.log('Fetching messages...');
                const response = await _supabase
                    .from('messages')
                    .select('*')
                    .order('created_at', { ascending: true })
                    .limit(100);

                console.log('Messages response:', response);
                const { data, error } = response;

                if (error) {
                    console.error('Error loading messages:', error);
                    emptyState.innerHTML = `
                        <i data-lucide="alert-circle" size="48"></i>
                        <h3>Could not load messages</h3>
                        <p style="max-width: 280px;">${error.message || 'Database error'}</p>
                        <button onclick="loadMessages()" style="margin-top: 16px; padding: 10px 24px; background: #007aff; border-radius: 12px; font-weight: 600; font-size: 13px;">Retry</button>
                    `;
                    lucide.createIcons();
                    return;
                }

                messages = data || [];
                console.log('Loaded', messages.length, 'messages');
                renderMessages();
                scrollToBottom();
            } catch (e) {
                console.error('Exception loading messages:', e);
                emptyState.innerHTML = `
                    <i data-lucide="wifi-off" size="48"></i>
                    <h3>Connection Issue</h3>
                    <p style="max-width: 280px;">${e.message || 'Could not connect to the server.'}</p>
                    <button onclick="loadMessages()" style="margin-top: 16px; padding: 10px 24px; background: #007aff; border-radius: 12px; font-weight: 600; font-size: 13px;">Retry</button>
                `;
                lucide.createIcons();
            }
        }

        function setupRealtimeSubscription() {
            console.log('Setting up realtime subscription...');

            messagesChannel = _supabase
                .channel('chat-room')
                .on('broadcast', { event: 'new-message' }, (payload) => {
                    console.log('Broadcast message received:', payload);
                    const newMessage = payload.payload;

                    // Don't add our own messages (already added via optimistic UI)
                    if (newMessage.user_id === currentUser.id) return;

                    // Check if message already exists
                    if (!messages.find(m => m.id === newMessage.id)) {
                        messages.push(newMessage);
                        appendMessage(newMessage);
                        scrollToBottom();
                    }
                })
                .on('broadcast', { event: 'message-update' }, (payload) => {
                    console.log('Broadcast update received:', payload);
                    const updatedMessage = payload.payload;
                    const index = messages.findIndex(m => m.id === updatedMessage.id);
                    if (index !== -1) {
                        messages[index] = updatedMessage;
                        updateMessageReactions(updatedMessage);
                    }
                })
                .subscribe((status) => {
                    console.log('Chat room channel status:', status);
                });
        }

        // Function to broadcast a message to all clients
        function broadcastMessage(message) {
            if (messagesChannel) {
                messagesChannel.send({
                    type: 'broadcast',
                    event: 'new-message',
                    payload: message
                });
            }
        }

        // Function to broadcast a message update
        function broadcastUpdate(message) {
            if (messagesChannel) {
                messagesChannel.send({
                    type: 'broadcast',
                    event: 'message-update',
                    payload: message
                });
            }
        }

        function setupPresence() {
            console.log('Setting up presence...');
            const userName = currentUser.user_metadata?.full_name || 'Anonymous';
            const userAvatar = currentUser.user_metadata?.avatar_url ||
                `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=0a84ff&color=fff`;

            presenceChannel = _supabase.channel('online-users', {
                config: { presence: { key: currentUser.id } }
            });

            presenceChannel
                .on('presence', { event: 'sync' }, () => {
                    const state = presenceChannel.presenceState();
                    console.log('Presence sync:', state);
                    onlineUsers.clear();

                    for (const [userId, presence] of Object.entries(state)) {
                        if (presence.length > 0) {
                            onlineUsers.set(userId, presence[0]);
                        }
                    }
                    updateOnlineCount();
                })
                .on('presence', { event: 'join' }, ({ key, newPresences }) => {
                    console.log('User joined:', key, newPresences);
                    if (newPresences.length > 0) {
                        onlineUsers.set(key, newPresences[0]);
                        updateOnlineCount();
                    }
                })
                .on('presence', { event: 'leave' }, ({ key }) => {
                    console.log('User left:', key);
                    onlineUsers.delete(key);
                    updateOnlineCount();
                })
                .subscribe(async (status) => {
                    console.log('Presence channel status:', status);
                    if (status === 'SUBSCRIBED') {
                        console.log('Tracking presence for user:', currentUser.id);
                        await presenceChannel.track({
                            user_id: currentUser.id,
                            user_name: userName,
                            user_avatar: userAvatar,
                            online_at: new Date().toISOString()
                        });
                        // Update count to at least 1 (current user)
                        updateOnlineCount();
                    }
                });
        }

        function updateOnlineCount() {
            // Always show at least 1 if we're connected
            const count = Math.max(onlineUsers.size, currentUser ? 1 : 0);
            document.getElementById('online-count').textContent = `${count} online`;
            console.log('Online users count:', count, 'Map size:', onlineUsers.size);
        }

        function renderMessages() {
            const container = document.getElementById('messages-area');
            const emptyState = document.getElementById('empty-state');

            if (messages.length === 0) {
                emptyState.style.display = 'flex';
                return;
            }

            emptyState.style.display = 'none';
            container.innerHTML = '';

            let lastDate = null;
            messages.forEach(msg => {
                const msgDate = new Date(msg.created_at).toDateString();
                if (msgDate !== lastDate) {
                    container.appendChild(createDateDivider(msg.created_at));
                    lastDate = msgDate;
                }
                container.appendChild(createMessageElement(msg));
            });
        }

        function createDateDivider(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            let label;
            if (date.toDateString() === today.toDateString()) {
                label = 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                label = 'Yesterday';
            } else {
                label = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }

            const div = document.createElement('div');
            div.className = 'date-divider';
            div.innerHTML = `<span>${label}</span>`;
            return div;
        }

        function createMessageElement(msg) {
            const isOwn = msg.user_id === currentUser.id;
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${isOwn ? 'own' : 'other'}`;
            wrapper.dataset.messageId = msg.id;

            const time = new Date(msg.created_at).toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });

            const reactions = msg.reactions || {};
            let reactionsHtml = '';

            if (Object.keys(reactions).length > 0) {
                reactionsHtml = '<div class="message-reactions">';
                for (const [emoji, users] of Object.entries(reactions)) {
                    const isActive = users.includes(currentUser.id);
                    reactionsHtml += `
                        <div class="reaction-badge ${isActive ? 'active' : ''}" onclick="toggleReaction('${msg.id}', '${emoji}')">
                            <span>${emoji}</span>
                            <span class="reaction-count">${users.length}</span>
                        </div>
                    `;
                }
                reactionsHtml += '</div>';
            }

            // Get avatar URL - use stored avatar or generate from name
            const avatarUrl = msg.user_avatar ||
                `https://ui-avatars.com/api/?name=${encodeURIComponent(msg.user_name || 'U')}&background=0a84ff&color=fff&size=64`;

            if (isOwn) {
                // Own message - no avatar, right aligned
                wrapper.innerHTML = `
                    <div class="message-bubble" oncontextmenu="showContextMenu(event, '${msg.id}')" ontouchstart="handleTouchStart(event, '${msg.id}')" ontouchend="handleTouchEnd(event)">
                        ${escapeHtml(msg.content)}
                    </div>
                    ${reactionsHtml}
                    <div class="message-time">${time}</div>
                `;
            } else {
                // Other's message - show avatar
                wrapper.innerHTML = `
                    <div class="message-row">
                        <img src="${avatarUrl}" class="message-avatar" alt="">
                        <div class="message-content">
                            <div class="message-sender">${msg.user_name || 'Anonymous'}</div>
                            <div class="message-bubble" oncontextmenu="showContextMenu(event, '${msg.id}')" ontouchstart="handleTouchStart(event, '${msg.id}')" ontouchend="handleTouchEnd(event)">
                                ${escapeHtml(msg.content)}
                            </div>
                            ${reactionsHtml}
                            <div class="message-time">${time}</div>
                        </div>
                    </div>
                `;
            }

            return wrapper;
        }

        function appendMessage(msg) {
            const container = document.getElementById('messages-area');
            const emptyState = document.getElementById('empty-state');
            emptyState.style.display = 'none';

            const lastMessage = container.querySelector('.message-wrapper:last-child');
            const msgDate = new Date(msg.created_at).toDateString();

            if (lastMessage) {
                const lastMsgId = lastMessage.dataset.messageId;
                const lastMsg = messages.find(m => m.id == lastMsgId);
                if (lastMsg) {
                    const lastMsgDate = new Date(lastMsg.created_at).toDateString();
                    if (msgDate !== lastMsgDate) {
                        container.appendChild(createDateDivider(msg.created_at));
                    }
                }
            } else {
                container.appendChild(createDateDivider(msg.created_at));
            }

            container.appendChild(createMessageElement(msg));
        }

        function updateMessageReactions(msg) {
            const wrapper = document.querySelector(`[data-message-id="${msg.id}"]`);
            if (!wrapper) return;

            let reactionsContainer = wrapper.querySelector('.message-reactions');
            const reactions = msg.reactions || {};

            let reactionsHtml = '';
            if (Object.keys(reactions).length > 0) {
                for (const [emoji, users] of Object.entries(reactions)) {
                    const isActive = users.includes(currentUser.id);
                    reactionsHtml += `
                        <div class="reaction-badge ${isActive ? 'active' : ''}" onclick="toggleReaction('${msg.id}', '${emoji}')">
                            <span>${emoji}</span>
                            <span class="reaction-count">${users.length}</span>
                        </div>
                    `;
                }
            }

            if (reactionsContainer) {
                if (reactionsHtml) {
                    reactionsContainer.innerHTML = reactionsHtml;
                } else {
                    reactionsContainer.remove();
                }
            } else if (reactionsHtml) {
                const bubble = wrapper.querySelector('.message-bubble');
                const newReactionsDiv = document.createElement('div');
                newReactionsDiv.className = 'message-reactions';
                newReactionsDiv.innerHTML = reactionsHtml;
                bubble.after(newReactionsDiv);
            }
        }

        function scrollToBottom() {
            const container = document.getElementById('messages-area');
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        function handleInput(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            document.getElementById('send-btn').disabled = !textarea.value.trim();
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            if (!content) return;

            const userName = currentUser.user_metadata?.full_name || 'Anonymous';
            const userAvatar = currentUser.user_metadata?.avatar_url ||
                `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=0a84ff&color=fff`;

            input.value = '';
            input.style.height = 'auto';
            document.getElementById('send-btn').disabled = true;

            // Optimistic UI
            const tempId = 'temp-' + Date.now();
            const tempMessage = {
                id: tempId,
                user_id: currentUser.id,
                user_name: userName,
                user_avatar: userAvatar,
                content: content,
                reactions: {},
                created_at: new Date().toISOString()
            };

            messages.push(tempMessage);
            appendMessage(tempMessage);
            scrollToBottom();
            document.getElementById('empty-state').style.display = 'none';

            try {
                const { data, error } = await _supabase.from('messages').insert({
                    user_id: currentUser.id,
                    user_name: userName,
                    user_avatar: userAvatar,
                    content: content,
                    reactions: {}
                }).select();

                if (error) {
                    console.error('Error sending message:', error);
                    messages = messages.filter(m => m.id !== tempId);
                    const tempEl = document.querySelector(`[data-message-id="${tempId}"]`);
                    if (tempEl) tempEl.remove();
                    input.value = content;
                    document.getElementById('send-btn').disabled = false;
                    alert('Failed to send: ' + (error.message || 'Unknown error'));
                } else if (data && data[0]) {
                    const realMessage = data[0];
                    const tempIndex = messages.findIndex(m => m.id === tempId);
                    if (tempIndex !== -1) messages[tempIndex] = realMessage;
                    const tempEl = document.querySelector(`[data-message-id="${tempId}"]`);
                    if (tempEl) tempEl.dataset.messageId = realMessage.id;

                    // Broadcast to other clients
                    broadcastMessage(realMessage);
                    console.log('Message broadcasted:', realMessage);
                }
            } catch (e) {
                console.error('Exception sending message:', e);
                messages = messages.filter(m => m.id !== tempId);
                const tempEl = document.querySelector(`[data-message-id="${tempId}"]`);
                if (tempEl) tempEl.remove();
                input.value = content;
                document.getElementById('send-btn').disabled = false;
            }
        }

        async function toggleReaction(messageId, emoji) {
            const msg = messages.find(m => m.id == messageId);
            if (!msg) return;

            const reactions = { ...(msg.reactions || {}) };
            if (!reactions[emoji]) reactions[emoji] = [];

            const userIndex = reactions[emoji].indexOf(currentUser.id);
            if (userIndex === -1) {
                reactions[emoji].push(currentUser.id);
            } else {
                reactions[emoji].splice(userIndex, 1);
                if (reactions[emoji].length === 0) delete reactions[emoji];
            }

            // Update locally first
            msg.reactions = reactions;
            updateMessageReactions(msg);

            // Save to database
            const { data, error } = await _supabase
                .from('messages')
                .update({ reactions })
                .eq('id', messageId)
                .select();

            // Broadcast update to other clients
            if (data && data[0]) {
                broadcastUpdate(data[0]);
            }
        }

        // Context Menu
        let touchTimer = null;
        function handleTouchStart(event, messageId) {
            touchTimer = setTimeout(() => showContextMenu(event, messageId), 500);
        }

        function handleTouchEnd() {
            if (touchTimer) { clearTimeout(touchTimer); touchTimer = null; }
        }

        function showContextMenu(event, messageId) {
            event.preventDefault();
            selectedMessageId = messageId;

            const menu = document.getElementById('context-menu');
            const x = event.touches ? event.touches[0].clientX : event.clientX;
            const y = event.touches ? event.touches[0].clientY : event.clientY;

            menu.style.left = Math.min(x, window.innerWidth - 160) + 'px';
            menu.style.top = Math.min(y - 80, window.innerHeight - 120) + 'px';
            menu.classList.add('show');

            setTimeout(() => {
                document.addEventListener('click', hideContextMenu, { once: true });
            }, 10);
        }

        function hideContextMenu() {
            document.getElementById('context-menu').classList.remove('show');
            selectedMessageId = null;
        }

        function addReaction() {
            hideContextMenu();
            document.getElementById('reaction-modal').classList.remove('hidden');
        }

        function hideReactionPicker() {
            document.getElementById('reaction-modal').classList.add('hidden');
        }

        function selectReaction(emoji) {
            if (selectedMessageId) toggleReaction(selectedMessageId, emoji);
            hideReactionPicker();
            selectedMessageId = null;
        }

        function copyMessage() {
            const msg = messages.find(m => m.id == selectedMessageId);
            if (msg) navigator.clipboard.writeText(msg.content);
            hideContextMenu();
        }

        function showOnlineUsers() {
            console.log('Showing online users, count:', onlineUsers.size);
            const modal = document.getElementById('online-modal');
            const list = document.getElementById('online-users-list');
            list.innerHTML = '';

            // Show current user first
            if (currentUser) {
                const userName = currentUser.user_metadata?.full_name || 'You';
                const userAvatar = currentUser.user_metadata?.avatar_url ||
                    `https://ui-avatars.com/api/?name=${userName}&background=0a84ff&color=fff`;

                const item = document.createElement('div');
                item.className = 'flex items-center gap-3 p-3 rounded-xl liquid-glass mb-2';
                item.innerHTML = `
                    <img src="${userAvatar}" class="w-10 h-10 rounded-full object-cover bg-zinc-800">
                    <div class="flex-1">
                        <div class="font-semibold text-sm">${escapeHtml(userName)} (You)</div>
                        <div class="text-xs text-green-400 flex items-center gap-1">
                            <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                            Online
                        </div>
                    </div>
                `;
                list.appendChild(item);
            }

            onlineUsers.forEach((user, id) => {
                if (id === currentUser?.id) return;
                const item = document.createElement('div');
                item.className = 'flex items-center gap-3 p-3 rounded-xl liquid-glass';
                item.innerHTML = `
                    <img src="${user.user_avatar}" class="w-10 h-10 rounded-full object-cover bg-zinc-800">
                    <div class="flex-1">
                        <div class="font-semibold text-sm">${escapeHtml(user.user_name)}</div>
                        <div class="text-xs text-green-400 flex items-center gap-1">
                            <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                            Online
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });

            modal.classList.remove('hidden');
        }

        function hideOnlineUsers() {
            document.getElementById('online-modal').classList.add('hidden');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (presenceChannel) presenceChannel.untrack();
        });
    </script>
</body>

</html>
